-- NGUYENLENHATDANG-23520231-103.sql
CREATE DATABASE QLPT
USE QLPT

CREATE TABLE PHONGTRO (
	MAPT CHAR(5) PRIMARY KEY,
	TENPT NVARCHAR(50),
	DIENTICH FLOAT,
	GIAPT MONEY,
	TINHTRANGPT NVARCHAR(20)
)

CREATE TABLE CUDAN (
	MACD CHAR(5) PRIMARY KEY,
	HOTEN NVARCHAR(50),
	CCCD NVARCHAR(12),
	DIACHI NVARCHAR(100),
	SODT VARCHAR(15), 
	NGAYTHUE SMALLDATETIME,
	TRANGTHAICD NVARCHAR(15)
)
CREATE TABLE HOPDONG (
	MAHD CHAR(5) PRIMARY KEY,
	MACD CHAR(5),
	MAPT CHAR(5),
	NGAYKY SMALLDATETIME,
	NGAYHETHAN SMALLDATETIME,
	TRANGTHAIHD NVARCHAR(20)
	CONSTRAINT FK_HD_CD FOREIGN KEY(MACD) REFERENCES CUDAN(MACD),
	CONSTRAINT FK_HD_PT FOREIGN KEY(MAPT) REFERENCES PHONGTRO(MAPT),
)
CREATE TABLE DICHVU (
	MADV CHAR(5) PRIMARY KEY,
	TENDV NVARCHAR(50),
	DONGIA MONEY
)
CREATE TABLE PHIEUTINHTIEN (
	MAPTT CHAR(5) PRIMARY KEY,
	MAHD CHAR(5),
	SOTIENDICHVU MONEY,
	SOTIENTHUEPT MONEY,
	TONGTIENTT MONEY,
	NGAYTINHTIEN SMALLDATETIME,
	TINHTRANGTT NVARCHAR(20),
	PHUONGTHUCTT NVARCHAR(20),
	CONSTRAINT FK_PTT_HD FOREIGN KEY(MAHD) REFERENCES HOPDONG(MAHD)
)
CREATE TABLE CHITIETTTDV (
	MAPTT CHAR(5),
	MADV CHAR(5),
	CHISODV FLOAT,
	THANHTIEN MONEY,
	CONSTRAINT PK_CHITIETTDV PRIMARY KEY(MAPTT, MADV),
	CONSTRAINT FK_CT_PTT FOREIGN KEY(MAPTT) REFERENCES PHIEUTINHTIEN(MAPTT),
	CONSTRAINT FK_CT_DV FOREIGN KEY(MADV) REFERENCES DICHVU(MADV)
)
-- Du Lieu PHONGTRO
INSERT INTO PHONGTRO (MAPT, TENPT, DIENTICH, GIAPT, TINHTRANGPT) VALUES
('P001', 'Phong 101', 24, 5000000, 'Da cho thue'),
('P002', 'Phong 102', 24, 3800000, 'Da cho thue'),
('P003', 'Phong 103', 36, 4800000, 'Da cho thue'),
('P004', 'Phong 104', 24, 3800000, 'Da cho thue'),
('P005', 'Phong 105', 40, 8000000, 'Da cho thue'),
('P006', 'Phong 106', 36, 5800000, 'Trong'),
('P007', 'Phong 107', 28, 3800000, 'Da cho thue'),
('P008', 'Phong 108', 28, 4200000, 'Da cho thue'),
('P009', 'Phong 109', 28, 4200000, 'Trong'),
('P010', 'Phong 110', 40, 8000000, 'Da cho thue');

-- Thêm dữ liệu vào bảng CUDAN
INSERT INTO CUDAN (MACD, HOTEN, CCCD, DIACHI, SODT, NGAYTHUE, TRANGTHAICD) VALUES
('CD001', 'Nguyen Huu Phu', '227635273657', 'Ha Noi', '0367456276', '2024-10-01', 'Da roi di'),
('CD002', 'Le Thi Thanh Thao', '673272832422', 'Hai Phong', '0927482749', '2024-10-01', 'Dang o'),
('CD003', 'Tran Nguyen Huu Phuc', '125266729012', 'Da Nang', '0978123456', '2024-10-15', 'Da roi di'),
('CD004', 'Pham Minh Du', '523483690902', 'Ho Chi Minh', '0888536467', '2024-10-30', 'Dang o'),
('CD005', 'Hoang Thu Hieu', '736862746710', 'Khanh Hoa', '0904897595', '2024-11-01', 'Dang o'),
('CD006', 'Tran Khanh Thi', '237864874844', 'Binh Đinh', '0917363487', '2024-11-15', 'Dang o'),
('CD007', 'Do Van Nam', '980748392617', 'Ho Chi Minh', '0900635473', '2024-11-15', 'Da roi di'),
('CD008', 'Pham Chien Si', '194784625466', 'Vinh Long', '0990237847', '2024-12-01', 'Dang o'),
('CD009', 'Luu Thanh Tu', '998467745644', 'Ca Mau', '0911734784', '2024-12-10', 'Dang o'),
('CD010', 'Bui Thi Mong Uyen', '121234678908', 'Hoa Binh', '0328267480', '2024-12-15', 'Dang o');

-- Thêm dữ liệu vào bảng HOPDONG
INSERT INTO HOPDONG (MAHD, MACD, MAPT, NGAYKY, NGAYHETHAN, TRANGTHAIHD) VALUES
('HD001', 'CD001', 'P002', '2024-10-01', '2024-10-31', 'Da het han'),
('HD002', 'CD002', 'P004', '2024-10-01', '2024-11-30', 'Da het han'),
('HD003', 'CD003', 'P006', '2024-10-15', '2024-11-14', 'Da het han'),
('HD004', 'CD004', 'P001', '2024-10-30', '2025-03-31', 'Dang thue'),
('HD005', 'CD005', 'P003', '2024-11-01', '2025-03-31', 'Dang thue'),
('HD006', 'CD006', 'P005', '2024-11-15', '2025-05-14', 'Dang thue'),
('HD007', 'CD004', 'P006', '2024-11-15', '2024-12-14', 'Da het han'),
('HD008', 'CD002', 'P004', '2024-12-01', '2025-03-31', 'Dang thue'),
('HD009', 'CD007', 'P009', '2024-12-01', '2024-12-31', 'Da het han'),
('HD010', 'CD008', 'P002', '2024-12-01', '2025-05-31', 'Dang thue'),
('HD011', 'CD009', 'P007', '2024-12-10', '2025-06-09', 'Dang thue'),
('HD012', 'CD010', 'P008', '2024-12-15', '2025-09-14', 'Dang thue'),
('HD013', 'CD006', 'P010', '2025-01-01', '2025-12-31', 'Dang thue');


-- Thêm dữ liệu vào bảng DICHVU
INSERT INTO DICHVU (MADV, TENDV, DONGIA) VALUES
('DV001', 'Dien', 3500),
('DV002', 'Nuoc', 10000),
('DV003', 'Internet', 150000),
('DV004', 'Ve sinh', 50000),
('DV005', 'Truyen hinh cap', 160000);

-- Thêm dữ liệu vào bảng THANHTOAN
INSERT INTO PHIEUTINHTIEN (MAPTT, MAHD, SOTIENDICHVU, SOTIENTHUEPT, TONGTIENTT, NGAYTINHTIEN, TINHTRANGTT, PHUONGTHUCTT) VALUES
('TT001', 'HD001', 0, 3800000, 3800000, '2024-10-01', 'Da thanh toan', 'Chuyen khoan'),
('TT002', 'HD002', 0, 3800000, 3000000, '2024-10-01', 'Da thanh toan', 'Chuyen khoan'),
('TT003', 'HD003', 0, 5800000, 5800000, '2024-10-15', 'Da thanh toan', 'Tien mat'),
('TT004', 'HD004', 0, 5000000, 5000000, '2024-10-30', 'Da thanh toan', 'Chuyen khoan'),
('TT005', 'HD005', 0, 4800000, 4800000, '2024-11-01', 'Da thanh toan', 'Chuyen khoan'),
('TT006', 'HD001', 402000, 0, 402000, '2024-11-01', 'Da thanh toan', 'Chuyen khoan'),
('TT007', 'HD002', 289000, 3800000, 4089000, '2024-11-01', 'Da thanh toan', 'Tien mat'),
('TT008', 'HD003', 320000, 0, 320000, '2024-11-15', 'Da thanh toan', 'Chuyen khoan'),
('TT009', 'HD006', 0, 8000000, 8000000, '2024-11-15', 'Da thanh toan', 'Chuyen khoan'),
('TT010', 'HD007', 0, 5800000, 5800000, '2024-11-15', 'Da thanh toan', 'Chuyen khoan'),
('TT011', 'HD002', 296000, 0, 296000, '2024-12-01', 'Da thanh toan', 'Chuyen khoan'),
('TT012', 'HD004', 396000, 5000000, 5396000, '2024-12-01', 'Da thanh toan', 'Tien mat'),
('TT013', 'HD005', 204500, 4800000, 5004500, '2024-12-01', 'Da thanh toan', 'Tien mat'),
('TT014', 'HD008', 0, 3800000, 3800000, '2024-12-01', 'Da thanh toan', 'Chuyen khoan'),
('TT015', 'HD009', 0, 4200000, 4200000, '2024-12-01', 'Da thanh toan', 'Tien mat'),
('TT016', 'HD010', 0, 3800000, 3800000, '2024-12-01', 'Da thanh toan', 'Tien mat'),
('TT017', 'HD011', 0, 3800000, 3800000, '2024-12-10', 'Da thanh toan', 'Chuyen khoan'),
('TT018', 'HD012', 0, 4200000, 4200000, '2024-12-10', 'Da thanh toan', 'Tien mat'),
('TT019', 'HD006', 382000, 8000000, 8382000, '2024-12-15', 'Da thanh toan', 'Tien mat'),
('TT020', 'HD007', 320000, 0, 320000, '2024-12-15', 'Da thanh toan', 'Chuyen khoan');


-- Thêm dữ liệu vào bảng CHITIETTTDV
INSERT INTO CHITIETTTDV (MAPTT, MADV, CHISODV, THANHTIEN) VALUES
('TT006', 'DV001', 32, 112000),
('TT006', 'DV002', 9, 90000),
('TT006', 'DV003', 1, 150000),
('TT006', 'DV004', 1, 50000),
('TT007', 'DV001', 14, 49000),
('TT007', 'DV002', 4, 40000),
('TT007', 'DV003', 1, 150000),
('TT007', 'DV004', 1, 50000),
('TT008', 'DV001', 20, 70000),
('TT008', 'DV002', 5, 50000),
('TT008', 'DV003', 1, 150000),
('TT008', 'DV004', 1, 50000),
('TT011', 'DV001', 16, 56000),
('TT011', 'DV002', 4, 40000),
('TT011', 'DV003', 1, 150000),
('TT011', 'DV004', 1, 50000),
('TT012', 'DV001', 36, 126000),
('TT012', 'DV002', 9, 90000),
('TT012', 'DV003', 1, 150000),
('TT012', 'DV004', 1, 50000),
('TT013', 'DV001', 27, 94500),
('TT013', 'DV002', 6, 60000),
('TT013', 'DV004', 1, 50000),
('TT019', 'DV001', 32, 112000),
('TT019', 'DV002', 7, 70000),
('TT019', 'DV003', 1, 150000),
('TT019', 'DV004', 1, 50000),
('TT020', 'DV001', 20, 70000),
('TT020', 'DV002', 5, 50000),
('TT020', 'DV003', 1, 150000),
('TT020', 'DV004', 1, 50000);

-- CAU 2.
-- 2.1
ALTER TABLE PHONGTRO
ADD CONSTRAINT CH_DT CHECK (DIENTICH BETWEEN 10 AND 50)
-- 2.2
ALTER TABLE PHIEUTINHTIEN
ADD CONSTRAINT CH_PTT CHECK (TINHTRANGTT = 'Chưa thanh toán' OR TINHTRANGTT = 'Đã thanh toán')
-- trong database không viết dấu
ALTER TABLE PHIEUTINHTIEN
ADD CONSTRAINT CH_PTT CHECK (TINHTRANGTT = 'Chua thanh toan' OR TINHTRANGTT = 'Da thanh toan')
-- 2.3
DROP TRIGGER TRG_INSERT_DICHVU
GO
CREATE TRIGGER TRG_INSERT_DICHVU ON CHITIETTTDV
AFTER INSERT
AS
BEGIN
	DECLARE @DONGIA MONEY 
	SELECT @DONGIA = DONGIA
	FROM DICHVU
	DECLARE @CHISODV FLOAT, @MADV CHAR(5), @MAPTT CHAR(5)
	SELECT @CHISODV = CHISODV, @MADV = MADV, @MAPTT = MAPTT
	FROM INSERTED
	-- RANG BUOC
	UPDATE CHITIETTTDV
	SET THANHTIEN = @CHISODV * @DONGIA
	WHERE MADV = @MADV AND MAPTT = @MAPTT
END

-- 3.
-- 3.1
SELECT HD.MAPT, TENPT, HD.MACD, HOTEN
FROM PHONGTRO PT
	INNER JOIN HOPDONG HD ON PT.MAPT = HD.MAPT
	INNER JOIN CUDAN CD ON CD.MACD = HD.MACD
WHERE GIAPT > 5000000 AND YEAR(NGAYKY) = 2024
-- 3.2
SELECT DV.MADV, DV.TENDV
FROM DICHVU DV
INNER JOIN CHITIETTTDV CT ON DV.MADV = CT.MADV
INNER JOIN PHIEUTINHTIEN PT ON PT.MAPTT = CT.MAPTT
WHERE MAHD = 'HD002' AND YEAR(NGAYTINHTIEN) = 2024 AND MONTH(NGAYTINHTIEN) = 11
INTERSECT
SELECT DV.MADV, DV.TENDV
FROM DICHVU DV
INNER JOIN CHITIETTTDV CT ON DV.MADV = CT.MADV
INNER JOIN PHIEUTINHTIEN PT ON PT.MAPTT = CT.MAPTT
WHERE MAHD = 'HD002' AND YEAR(NGAYTINHTIEN) = 2024 AND MONTH(NGAYTINHTIEN) = 12
-- 3.3 
SELECT MAPTT, MAHD
FROM PHIEUTINHTIEN PT
WHERE YEAR(NGAYTINHTIEN) = 2024 
AND NOT EXISTS (
	SELECT *
	FROM DICHVU DV
	WHERE DONGIA <= 150000
	AND NOT EXISTS (
		SELECT *
		FROM CHITIETTTDV CT
		WHERE CT.MADV = DV.MADV
		AND CT.MAPTT = PT.MAPTT
	)
)

-- 3.4
SELECT HD.MAHD, HD.MACD, COUNT(*) AS SOLUONG
FROM HOPDONG HD
INNER JOIN PHIEUTINHTIEN PT ON HD.MAHD = PT.MAHD
WHERE PHUONGTHUCTT = 'Chuyen khoan' AND YEAR(NGAYTINHTIEN) = 2024
GROUP BY HD.MAHD, HD.MACD

-- 3.5
SELECT HD.MACD, A.HOTEN
FROM HOPDONG HD
	INNER JOIN 
	PHIEUTINHTIEN PT ON PT.MAHD = HD.MAHD,
				(SELECT TOP 1 WITH TIES HD.MACD, HOTEN, COUNT(MAHD) AS SOHOPDONG
				FROM CUDAN CD 
				INNER JOIN HOPDONG HD ON CD.MACD = HD.MACD
				GROUP BY HD.MACD, HOTEN
				ORDER BY COUNT(MAHD) DESC) AS A
WHERE A.MACD = HD.MACD
AND YEAR(NGAYTINHTIEN) = 2024
GROUP BY HD.MACD, A.HOTEN
HAVING SUM(TONGTIENTT) > 15000000


-- 180/1, Khu phố 2, Phường Tân Hoà, Thành phố Biên Hoà, Tỉnh Đồng Nai
